# config/opflows/workflows.yaml

common_settings:
  output_base_dir: "outputs"
  device: "cuda" # or "cpu"
  # Define common variable mapping (used by VariableMapper or DataStandardizer)
  # This can be overridden or extended at workflow/step level if needed
  var_map:
    # ERA5 specific variable names mapping to a common internal name if desired
    '10m_u_component_of_wind': 'u10',
    '10m_v_component_of_wind': 'v10',
    '2m_temperature': 't2m',
    'mean_sea_level_pressure': 'msl',
    'surface_pressure': 'sp',
    'u_component_of_wind': 'u',
    'v_component_of_wind': 'v',
    'geopotential': 'z',
    'temperature': 't',
    'specific_humidity': 'q',
    # SFNO specific outputs that might need mapping if different from target
    # 'sfno_var_u': 'u',
    # 'sfno_var_t': 't',

# Define reusable resources and parameters
resources:
  # Initial condition file for the model. This would typically be generated by ERA5DataManager
  initial_condition_file: "ncdb/era5_input_2023010100.nc" # Placeholder, actual path needed
  # Regional of Interest (ROI) for downscaling. Example for Taiwan area.
  regional_roi:
    lat_max: 26.0
    lat_min: 21.0
    lon_min: 119.0
    lon_max: 123.0
  coupling_alpha: 0.1 # Nudging coefficient for feedback coupler
  forecast_steps: 24 # Number of forecast steps for the model

# Define specific workflows
workflows:
  # ----------------------------------------------------------------
  # Workflow A: One-Way Downscaling (純降尺度)
  # Process: Load -> Infer -> Slice Regional ROI -> Save Regional Input
  # ----------------------------------------------------------------
  one_way_downscaling:
    steps:
      - name: "Initialize Model Loader"
        module: "src.op.global_operators"
        class: "ModelLoader"
        action: "instantiate"
        args:
          device: "{common_settings.device}"
        output_key: "loader_instance" # Stored for later use

      - name: "Load SFNO Model"
        instance_key: "loader_instance" # Use the instance created above
        action: "load_sfno_model"
        output_key: "sfno_model" # Stores the loaded SFNO model object

      - name: "Load Initial Conditions"
        instance_key: "loader_instance"
        action: "load_nc_file"
        args:
          path: "{resources.initial_condition_file}"
        output_key: "raw_initial_state" # Stores the raw xarray.Dataset

      - name: "Initialize Variable Mapper"
        module: "src.op.global_operators"
        class: "VariableMapper"
        action: "instantiate"
        args:
          variable_map: "{common_settings.var_map}" # Pass var_map from common settings
        output_key: "variable_mapper_instance"

      - name: "Standardize Initial State"
        instance_key: "variable_mapper_instance"
        action: "standardize"
        args:
          ds: "{raw_initial_state}" # Input the raw dataset
        output_key: "standardized_initial_state"

      - name: "Initialize Data Exporter"
        module: "src.op.global_operators"
        class: "DataExporter"
        action: "instantiate"
        args:
          output_dir: "{common_settings.output_base_dir}/one_way_downscaling"
        output_key: "exporter_instance"

      - name: "Initialize Inference Engine"
        module: "src.op.global_operators"
        class: "InferenceEngine"
        action: "instantiate"
        args:
          model: "{sfno_model}" # Reference the loaded SFNO model
        output_key: "inference_engine_instance"

      # --- Iterative Inference Loop ---
      - name: "Run SFNO Inference Loop"
        type: "iterator"
        source_object: "inference_engine_instance" # Object that provides the iterator
        method: "create_iterator"
        method_args:
          initial_state: "{standardized_initial_state}" # Initial state for the generator
        loop_limit: "{resources.forecast_steps}" # Number of steps to iterate
        loop_item_key: "current_forecast_ds" # Key for the output of each iteration (xarray.Dataset)
        steps: # Inner steps for each iteration
          - name: "Save Global Forecast for Step"
            instance_key: "exporter_instance"
            action: "save"
            args:
              ds: "{current_forecast_ds}" # Use the dataset from the current loop iteration
              prefix: "global_forecast_step_{step_index}" # step_index is dynamic within the loop

          - name: "Extract Regional Data for Downscaling"
            instance_key: "exporter_instance"
            action: "extract_region"
            args:
              ds: "{current_forecast_ds}"
              roi: "{resources.regional_roi}"
            output_key: "regional_data_for_downscaling" # Store the extracted region

          - name: "Save Regional Input for Step"
            instance_key: "exporter_instance"
            action: "save"
            args:
              ds: "{regional_data_for_downscaling}"
              prefix: "regional_input_step_{step_index}"

  # ----------------------------------------------------------------
  # Workflow B: Two-Way Coupling (雙向耦合)
  # Process: Load -> Infer -> (Load Regional Feedback) -> Blend -> Save Global
  # ----------------------------------------------------------------
  two_way_coupling:
    steps:
      - name: "Initialize Model Loader (Coupling)"
        module: "src.op.global_operators"
        class: "ModelLoader"
        action: "instantiate"
        args:
          device: "{common_settings.device}"
        output_key: "loader_instance_coupling"

      - name: "Load SFNO Model (Coupling)"
        instance_key: "loader_instance_coupling"
        action: "load_sfno_model"
        output_key: "sfno_model_coupling"

      - name: "Load Initial Conditions (Coupling)"
        instance_key: "loader_instance_coupling"
        action: "load_nc_file"
        args:
          path: "{resources.initial_condition_file}"
        output_key: "raw_initial_state_coupling"

      - name: "Initialize Variable Mapper (Coupling)"
        module: "src.op.global_operators"
        class: "VariableMapper"
        action: "instantiate"
        args:
          variable_map: "{common_settings.var_map}"
        output_key: "variable_mapper_instance_coupling"

      - name: "Standardize Initial State (Coupling)"
        instance_key: "variable_mapper_instance_coupling"
        action: "standardize"
        args:
          ds: "{raw_initial_state_coupling}"
        output_key: "standardized_initial_state_coupling"

      - name: "Initialize Feedback Coupler"
        module: "src.op.global_operators"
        class: "FeedbackCoupler"
        action: "instantiate"
        args:
          alpha: "{resources.coupling_alpha}"
        output_key: "coupler_instance"

      - name: "Initialize Data Exporter (Coupling)"
        module: "src.op.global_operators"
        class: "DataExporter"
        action: "instantiate"
        args:
          output_dir: "{common_settings.output_base_dir}/two_way_coupling"
        output_key: "exporter_instance_coupling"

      - name: "Initialize Inference Engine (Coupling)"
        module: "src.op.global_operators"
        class: "InferenceEngine"
        action: "instantiate"
        args:
          model: "{sfno_model_coupling}"
        output_key: "inference_engine_instance_coupling"

      # --- Iterative Coupled Inference Loop ---
      - name: "Run Coupled Inference Loop"
        type: "iterator"
        source_object: "inference_engine_instance_coupling"
        method: "create_iterator"
        method_args:
          initial_state: "{standardized_initial_state_coupling}"
        loop_limit: "{resources.forecast_steps}"
        loop_item_key: "current_coupled_forecast_ds"
        steps:
          # --- Simulating external regional model output ---
          # In a real scenario, a regional model would run here and produce 'regional_feedback_ds'
          # For this example, we'll simulate loading it or assume it's pre-existing.
          # We'll try to load a dummy file, but allow it to fail (ignore_errors)
          # A proper coupled system would have dedicated regional model run steps here.
          - name: "Load Regional Feedback (Simulated)"
            instance_key: "loader_instance_coupling"
            action: "load_nc_file"
            args:
              # Placeholder: Assume regional model output filename pattern
              path: "{common_settings.output_base_dir}/regional_model_output/feedback_step_{step_index}.nc"
            output_key: "regional_feedback_ds"
            ignore_errors: true # Allow this step to fail if file doesn't exist

          - name: "Blend Fields with Regional Feedback"
            condition: "regional_feedback_ds is not None" # Only blend if regional feedback was loaded
            instance_key: "coupler_instance"
            action: "blend_fields"
            args:
              global_ds: "{current_coupled_forecast_ds}"
              regional_ds: "{regional_feedback_ds}"
            output_key: "current_coupled_forecast_ds" # Update the forecast with blended data

          - name: "Save Coupled Global Forecast for Step"
            instance_key: "exporter_instance_coupling"
            action: "save"
            args:
              ds: "{current_coupled_forecast_ds}"
              prefix: "coupled_forecast_step_{step_index}"

  # ----------------------------------------------------------------
  # Workflow C: Initial Data Preparation (ERA5 -> NetCDF)
  # This workflow prepares the initial_condition_file used by other workflows.
  # ----------------------------------------------------------------
  prepare_era5_initial_data:
    steps:
      - name: "Initialize ERA5 Data Manager"
        module: "src.op.era5_reanalysis"
        class: "ERA5DataManager"
        action: "instantiate"
        args:
          output_dir: "ncdb" # Where to store the intermediate gribs and final nc
        output_key: "era5_manager"

      - name: "Prepare ERA5 Model Input"
        instance_key: "era5_manager"
        action: "prepare_model_input"
        args:
          datetime_str: "2023010100" # Example datetime
          sl_request: # Surface Level Request (from Code.md example)
            product_type: "reanalysis"
            format: "grib"
            variable: ["10m_u_component_of_wind", "10m_v_component_of_wind", "2m_temperature", "mean_sea_level_pressure", "surface_pressure"]
            year: "2023"
            month: "01"
            day: "01"
            time: "00:00"
            area: [90, -180, -90, 180] # Global
          pl_request: # Pressure Level Request (from Code.md example)
            product_type: "reanalysis"
            format: "grib"
            variable: ["u_component_of_wind", "v_component_of_wind", "geopotential", "temperature", "specific_humidity"]
            pressure_level: ["1000", "850", "500", "200", "50"]
            year: "2023"
            month: "01"
            day: "01"
            time: "00:00"
            area: [90, -180, -90, 180] # Global
          filename_prefix: "era5_input"
        output_key: "generated_initial_nc_file_path"
